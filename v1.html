<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IndaiaFibra</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
  --primary-color: #1E3A8A;
  --secondary-color: #06B6D4;
  --background-color: linear-gradient(to bottom, #1F2937, #111827);
  --text-color: #F9FAFB;
  --error-color: #DC2626;
  --nav-background-color: #1F2937;
  --section-background-color: #1F2937;
  --input-bg: #374151;
  --input-border: #4B5563;
  --input-text: #F9FAFB;
  --muted-text: #9CA3AF;
}

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
      transition: background 0.3s ease, color 0.3s ease;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(17, 24, 39, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .loader-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loader-icon {
      width: 48px;
      height: 48px;
      animation: float 1.5s ease-in-out infinite;
      z-index: 1;
    }

    .loader-spinner {
      position: absolute;
      border: 4px solid var(--secondary-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 64px;
      height: 64px;
      animation: spin 1s linear infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: #4B5563;
      border-radius: 4px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--secondary-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--secondary-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #mapInstalacao {
      height: 16rem;
      border: 1px solid var(--secondary-color);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1;
    }

    .error-message {
      color: var(--error-color);
      font-size: 0.875rem;
      display: none;
    }

    .tab-btn.active {
      background: var(--primary-color);
      color: var(--text-color);
      justify-content: flex-end;
transition: all .5s ease;
    }

    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1F2937;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      overflow-x: auto;
      white-space: nowrap;
      transition: height 0.3s ease;
    }

    nav.nav-minimized .tab-btn span {
      display: none;
    }

    .tab-btn {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0.5rem 1rem;
      transition: all .5s ease;
      overflow: hidden;
    }

    .tab-btn span {
      background: var(--primary-color);
      padding: 0.25rem 0.5rem;
      margin-left: 1rem;
      border-radius: 0.25rem;
      display: none; /* Oculto por padr√£o */
      width: auto;
      opacity: 0;
      white-space: nowrap;
      transition: opacity 0.2s ease-in-out;
    }

    .tab-btn.active span {
      display: flex; /* Exibido apenas no ativo */
      animation: typewriter .5s steps(40, end) forwards;
      justify-content: flex-end;
                  transition: all .5s ease;


    }

    .tab-btn i {
      transition: transform 0.8s ease-in-out, opacity 0.4s ease-in-out;
      display: inline-block; /* Sempre vis√≠vel */
      width: auto;
      opacity: 1;
    }

    .tab-btn.active i {
      animation: iconScale .8s ease-in-out forwards;
    }

    .tab-btn:hover i, .tab-btn:focus i {
      transform: scale(1.1) rotate(10deg);
      opacity: 0.9;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    @keyframes typewriter {
      from { width: 0; opacity: 0; }
      to { width: 100%; opacity: 1; }
    }

    @keyframes iconScale {
      from { transform: scale(1); }
      to { transform: scale(1.5) rotate(360deg); }
    }

    @keyframes fadeInBlur {
      from { opacity: 0; filter: blur(8px); }
      to { opacity: 1; filter: blur(0); }
    }

    .tab-content {
      opacity: 0;
      filter: blur(100px);
      transition: opacity 1s ease-in, filter 1s ease-out;
    }

    .tab-content.active {
      animation: fadeInBlur .6s ease-out forwards;
    }

    .logo-text {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    button, input[type="submit"] {
      background-color: var(--secondary-color);
      color: var(--text-color);
      transition: background-color 0.2s ease-in-out;
    }

    button:hover, input[type="submit"]:hover {
      background-color: var(--primary-color);
      color: var(--text-color);
    }

    .edit-btn {
      cursor: pointer;
      color: var(--secondary-color);
      margin-left: 0.5rem;
    }

    .edit-btn:hover {
      color: var(--primary-color);
    }

    @media (min-width: 768px) {
      #mapInstalacao { height: 24rem; }
      .tab-btn { font-size: 1rem; padding: 0.75rem 1.5rem; }
      .tab-btn.active span { max-width: 250px; }
    }

    @media (max-width: 767px) {
      .tab-btn { font-size: 0.875rem; padding: 0.5rem 1rem; }
      .tab-btn.active span { max-width: 150px; }
    }

    .historico-item {
      cursor: pointer;
      padding: 0.5rem;
      background-color: #374151;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .historico-item.expanded {
      background-color: #4B5563;
      padding: 1rem;
    }

    #searchHistorico {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      background-color: #374151;
      border: 1px solid #4B5563;
      border-radius: 0.25rem;
      color: #F9FAFB;
    }
    
    #usarLocalizacao{
      margin-top: 10px;
      width: 100%;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loader-container">
      <img src="https://img.icons8.com/?size=2x&id=Sd1fJXRt5uTd&format=png" alt="Loading Icon" class="loader-icon">
      <div class="loader-spinner"></div>
    </div>
  </div>

  <header class="bg-primary-color text-white p-4 flex justify-between items-center shadow-lg">
    <div class="flex items-center">
      <img src="https://img.icons8.com/?size=2x&id=Sd1fJXRt5uTd&format=png" alt="Logo IndaiaFibra" class="h-12 mr-2 cursor-pointer" id="logoIndaiaFibra">
      <h1 class="text-xl font-semibold logo-text">IndaiaFibra</h1>
    </div>
    <div class="text-sm">
      <span id="contadorInstalacoes">0 instala√ß√µes este m√™s</span>
    </div>
  </header>

  <main class="flex-grow p-6 max-w-4xl mx-auto mb-16">
    <section id="instalacao" class="tab-content" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <form id="formInstalacao" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="tipoTrabalho" class="block font-semibold text-gray-200">Tipo de trabalho *</label>
              <select id="tipoTrabalho" name="tipoTrabalho" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color">
                <option value="">Selecione</option>
                <option value="Instala√ß√£o">Instala√ß√£o</option>
                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
              </select>
              <p class="error-message mt-1">Por favor selecione o tipo de trabalho.</p>
            </div>
            <div>
              <label for="tecnico" class="block font-semibold text-gray-200">T√©cnico *</label>
              <select id="tecnico" name="tecnico" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color">
                <option value="">Selecione</option>
                <option value="Andr√©">Andr√©</option>
                <option value="Elvis">Elvis</option>
                <option value="Guilherme">Guilherme</option>
                <option value="Janderson">Janderson</option>
                <option value="Robson">Robson</option>
                <option value="S√©rgio">S√©rgio</option>
              </select>
              <p class="error-message mt-1">Por favor selecione o t√©cnico.</p>
            </div>
          </div>
          <div>
            <label for="cliente" class="block font-semibold text-gray-200">Cliente *</label>
            <input id="cliente" name="cliente" type="text" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Nome do cliente">
            <p class="error-message mt-1">Por favor informe o cliente.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="cto" class="block font-semibold text-gray-200">CTO *</label>
              <input id="cto" name="cto" type="text" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Identificador CTO">
              <p class="error-message mt-1">Por favor informe o CTO.</p>
            </div>
            <div>
              <label for="porta" class="block font-semibold text-gray-200">Porta *</label>
              <select id="porta" name="porta" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color">
                <option value="">Selecione</option>
                 <option value="1">Porta 1</option>
                <option value="2">Porta 2</option>
                <option value="3">Porta 3</option>
                <option value="4">Porta 4</option>
                <option value="5">Porta 5</option>
                <option value="6">Porta 6</option>
                <option value="7">Porta 7</option>
                <option value="8">Porta 8</option>
                <option value="9">Porta 9</option>
                <option value="10">Porta 10</option>
                <option value="11">Porta 11</option>
                <option value="12">Porta 12</option>
                <option value="13">Porta 13</option>
                <option value="14">Porta 14</option>
                <option value="15">Porta 15</option>
                <option value="16">Porta 16</option>
              </select>
              <p class="error-message mt-1">Por favor selecione a porta.</p>
            </div>
          </div>
          <div>
  <label for="sinalCTO" class="block font-semibold text-gray-200">Sinal da CTO </label>
  <input id="sinalCTO" name="sinalCTO" type="range" min="-30" max="-10" step="0.01" value="-20.00" class="w-full">
  <p id="valorSinalCTO" class="text-sm text-gray-400 mt-1">-20,00 dBm</p>
  <p class="error-message mt-1">Por favor ajuste o sinal da CTO entre -30,00 e -10,00 dBm.</p>
</div>
<div>
  <label for="sinalCliente" class="block font-semibold text-gray-200">Sinal do Cliente</label>
  <input id="sinalCliente" name="sinalCliente" type="range" min="-30" max="-10" step="0.01" value="-20.00" class="w-full">
  <p id="valorSinalCliente" class="text-sm text-gray-400 mt-1">-20,00 dBm</p>
  <p class="error-message mt-1">Por favor ajuste o sinal do cliente entre -30,00 e -10,00 dBm.</p>
</div>
          <div>
            <label class="block font-semibold text-gray-200">Localiza√ß√£o *</label>
            <div id="mapInstalacao" class="mt-2"></div>
<button
  type="button"
  id="usarLocalizacao"
  class="bg-secondary-color text-white px-2 py-3 rounded-lg hover:bg-primary-color flex items-center justify-center text-center"
>
  <i class="fas fa-map-marker-alt mr-2"></i> Usar minha localiza√ß√£o atual
</button>
            <input id="endereco" name="endereco" type="text" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg mt-3 text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Digite ou selecione no mapa">
          </div>
          <div>
            <label class="block font-semibold text-gray-200">Materiais para esta instala√ß√£o</label>
            <div id="materiaisSelecionaveis" class="space-y-3 mt-2"></div>
          </div>
          <button type="submit" class="bg-secondary-color text-white px-6 py-3 rounded-lg hover:bg-primary-color w-full md:w-auto">Enviar Instala√ß√£o</button>
        </form>
      </div>
    </section>

    <section id="materiais" class="tab-content hidden" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-200 mb-4">Gerenciar Materiais</h2>
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="nomeMaterial" class="block font-semibold text-gray-200">Nome do Material</label>
              <input id="nomeMaterial" type="text" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Ex: Cabo √ìptico">
            </div>
            <div>
              <label for="qtdMaterial" class="block font-semibold text-gray-200">Quantidade padr√£o</label>
              <input id="qtdMaterial" type="number" min="1" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Ex: 10">
            </div>
          </div>
          <button id="adicionarMaterial" class="bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">Adicionar</button>
          <div id="listaMateriais" class="space-y-3"></div>
        </div>
      </div>
    </section>

    <section id="historico" class="tab-content hidden" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-200 mb-4">Hist√≥rico de Instala√ß√µes</h2>
        <input type="text" id="searchHistorico" placeholder="Pesquisar..." class="mb-4">
        <div id="historicoInstalacoes" class="space-y-2"></div>
        <button id="limparHistorico" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-primary-color mt-4">Limpar Hist√≥rico</button>
      </div>
    </section>

    <section id="mapa" class="tab-content hidden" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-200 mb-4">Mapa CTOs</h2>
        <div class="space-y-4">
          <button id="openGoogleMaps" class="bg-secondary-color text-white px-6 py-3 rounded-lg hover:bg-primary-color flex items-center justify-center w-full md:w-auto">
            <i class="fas fa-map-pin mr-2"></i> Abrir no Google Maps
          </button>
          <button id="openGoogleEarth" class="bg-secondary-color text-white px-6 py-3 rounded-lg hover:bg-primary-color flex items-center justify-center w-full md:w-auto">
            <i class="fas fa-globe mr-2"></i> Abrir no Google Earth
          </button>
        </div>
      </div>
    </section>
  </main>

  <nav class="flex space-x-2 p-4 nav-minimized">
    <button data-tab="instalacao" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color active">
      <i class="fas fa-tools"></i><span>Instala√ß√£o</span>
    </button>
    <button data-tab="materiais" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">
      <i class="fas fa-box"></i><span>Materiais</span>
    </button>
    <button data-tab="historico" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">
      <i class="fas fa-history"></i><span>Hist√≥rico</span>
    </button>
    <button data-tab="mapa" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">
      <i class="fas fa-map-pin"></i><span>Mapa CTOs</span>
    </button>
  </nav>

  <footer class="bg-primary-color text-white p-4 text-center">
    <p>IndaiaFibra v1.13.0 ¬© 2025</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script></script>
                  
                  
                  <script>
  AOS.init({ duration: 600 });

  // Fallback para remover loading screen
  setTimeout(() => {
    const loading = document.getElementById('loading');
    if (loading) loading.style.display = 'none';
  }, 5000);

  window.addEventListener('load', () => {
    document.getElementById('loading').style.display = 'none';
  });

  let mapInstalacao, markerInstalacao;
  let enderecoTimeout;

  // Fun√ß√£o para trocar o tema
function toggleTheme() {
  const root = document.documentElement;
  const currentTheme = sessionStorage.getItem('theme') || 'default';
  
  if (currentTheme === 'default') {
    // Tema claro e vibrante
    root.style.setProperty('--primary-color', '#7C3AED'); // Roxo
    root.style.setProperty('--secondary-color', '#38BDF8'); // Azul claro
    root.style.setProperty('--background-color', 'linear-gradient(to bottom, #FFFFFF, #F3E8FF)');
    root.style.setProperty('--text-color', '#1F2937');
    root.style.setProperty('--nav-background-color', '#FFFFFF');
    root.style.setProperty('--section-background-color', '#EDE9FE');
    root.style.setProperty('--input-bg', '#F3F4F6'); // cinza claro
    root.style.setProperty('--input-border', '#D1D5DB'); // borda clara
    root.style.setProperty('--input-text', '#1F2937');
    root.style.setProperty('--muted-text', '#6B7280'); // para textos auxiliares
    sessionStorage.setItem('theme', 'alternate');
  } else {
    // Tema escuro padr√£o
    root.style.setProperty('--primary-color', '#1E3A8A');
    root.style.setProperty('--secondary-color', '#06B6D4');
    root.style.setProperty('--background-color', 'linear-gradient(to bottom, #1F2937, #111827)');
    root.style.setProperty('--text-color', '#F9FAFB');
    root.style.setProperty('--nav-background-color', '#1F2937');
    root.style.setProperty('--section-background-color', '#1F2937');
    root.style.setProperty('--input-bg', '#374151'); // gray-700
    root.style.setProperty('--input-border', '#4B5563'); // gray-600
    root.style.setProperty('--input-text', '#F9FAFB');
    root.style.setProperty('--muted-text', '#9CA3AF');
    sessionStorage.setItem('theme', 'default');
  }
  
  // Atualiza fundo e texto do body
  document.body.style.background = root.style.getPropertyValue('--background-color');
  document.body.style.color = root.style.getPropertyValue('--text-color');
  
  // Atualiza logo gradient
  const logo = document.querySelector('.logo-text');
  if (logo) {
    logo.style.backgroundImage = `linear-gradient(to right, ${root.style.getPropertyValue('--primary-color')}, ${root.style.getPropertyValue('--secondary-color')})`;
  }
  
  // Atualiza nav, footer, header
  document.querySelector('nav').style.backgroundColor = root.style.getPropertyValue('--nav-background-color');
  document.querySelector('footer').style.backgroundColor = root.style.getPropertyValue('--primary-color');
  document.querySelector('header').style.backgroundColor = root.style.getPropertyValue('--primary-color');
  
  // Atualiza se√ß√µes
  document.querySelectorAll('.bg-gray-800').forEach(el => {
    el.style.backgroundColor = root.style.getPropertyValue('--section-background-color');
  });
  
  // Atualiza inputs, selects, etc.
  document.querySelectorAll('input, select, textarea').forEach(el => {
    el.style.backgroundColor = root.style.getPropertyValue('--input-bg');
    el.style.borderColor = root.style.getPropertyValue('--input-border');
    el.style.color = root.style.getPropertyValue('--input-text');
  });
  
  // Atualiza textos auxiliares
  document.querySelectorAll('.text-gray-200, .text-gray-400').forEach(el => {
    el.style.color = root.style.getPropertyValue('--text-color');
  });
  
  document.querySelectorAll('.text-sm.text-gray-400').forEach(el => {
    el.style.color = root.style.getPropertyValue('--muted-text');
  });
  
  // Bot√µes com hover
  document.querySelectorAll('button').forEach(btn => {
    btn.style.transition = 'background-color 0.3s ease';
  });
}

  // Aplica o tema salvo ao carregar
  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = sessionStorage.getItem('theme') || 'default';
    if (savedTheme === 'alternate') {
      toggleTheme();
    }
    document.getElementById('logoIndaiaFibra').addEventListener('click', toggleTheme);
  });

  function initMaps() {
    mapInstalacao = L.map('mapInstalacao', { zoomControl: true }).setView([-23.21345, -47.29821], 15);
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
      attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | ¬© <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(mapInstalacao);

    const customIcon = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      shadowSize: [41, 41]
    });

    mapInstalacao.on('click', async (e) => {
      const { lat, lng } = e.latlng;
      updateMarker(lat, lng, mapInstalacao, 'markerInstalacao', customIcon);
      const endereco = await obterEndereco(lat, lng);
      document.getElementById('endereco').value = endereco;
    });

    // For√ßar re-renderiza√ß√£o do mapa
    setTimeout(() => mapInstalacao.invalidateSize(), 100);
  }

  function updateMarker(lat, lng, targetMap, markerType, icon) {
    sessionStorage.setItem('lat', lat);
    sessionStorage.setItem('lng', lng);
    if (markerType === 'markerInstalacao' && markerInstalacao) mapInstalacao.removeLayer(markerInstalacao);
    const newMarker = L.marker([lat, lng], { icon }).addTo(targetMap);
    if (markerType === 'markerInstalacao') markerInstalacao = newMarker;
    targetMap.setView([lat, lng], 17);
    targetMap.invalidateSize();
  }

  async function usarLocalizacao() {
    if (!navigator.geolocation) {
      alert('Geolocaliza√ß√£o n√£o suportada.');
      return;
    }
    const loading = document.getElementById('loading');
    loading.style.display = 'flex';
    document.getElementById('usarLocalizacao').disabled = true;

    const timeoutId = setTimeout(() => {
      loading.style.display = 'none';
      alert('N√£o foi poss√≠vel obter sua localiza√ß√£o dentro de 40 segundos. Tente novamente.');
      document.getElementById('usarLocalizacao').disabled = false;
    }, 40000);

    try {
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject);
      });
      clearTimeout(timeoutId);
      const { latitude: lat, longitude: lng } = pos.coords;
      const customIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        shadowSize: [41, 41]
      });
      updateMarker(lat, lng, mapInstalacao, 'markerInstalacao', customIcon);
      const endereco = await obterEndereco(lat, lng);
      document.getElementById('endereco').value = endereco;
    } catch {
      clearTimeout(timeoutId);
      alert('N√£o foi poss√≠vel obter sua localiza√ß√£o. Tente novamente.');
    } finally {
      loading.style.display = 'none';
      document.getElementById('usarLocalizacao').disabled = false;
    }
  }

  async function obterEndereco(lat, lng) {
    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error('Erro na API de endere√ßo');
      const data = await response.json();
      return `${data.address?.road || 'Rua desconhecida'}, ${data.address?.house_number || 's/n'}`;
    } catch {
      return 'Endere√ßo n√£o dispon√≠vel';
    }
  }

  async function buscarEndereco(endereco) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(endereco)}&format=jsonv2`;
      const response = await fetch(url);
      if (!response.ok) throw new Error('Erro na API de busca');
      const data = await response.json();
      if (data.length === 0) {
        alert('Endere√ßo n√£o encontrado.');
        return;
      }
      const { lat, lon: lng } = data[0];
      const customIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        shadowSize: [41, 41]
      });
      updateMarker(lat, lng, mapInstalacao, 'markerInstalacao', customIcon);
    } catch {
      alert('Erro ao buscar endere√ßo.');
    }
  }

  function toggleNav() {
    const nav = document.querySelector('nav');
    const isMinimized = nav.classList.toggle('nav-minimized');
    sessionStorage.setItem('navMinimized', isMinimized);
  }

  function adicionarMaterial() {
    const nome = document.getElementById('nomeMaterial').value.trim();
    const qtd = parseInt(document.getElementById('qtdMaterial').value);
    if (!nome) {
      alert('Por favor, informe o nome do material.');
      return;
    }
    if (isNaN(qtd) || qtd < 1) {
      alert('Por favor, informe uma quantidade v√°lida.');
      return;
    }

    try {
      const materiais = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');
      materiais[nome] = qtd;
      localStorage.setItem('materiaisDisponiveis', JSON.stringify(materiais));
      atualizarListaMateriais();
      atualizarMateriaisSelecionaveis();
      document.getElementById('nomeMaterial').value = '';
      document.getElementById('qtdMaterial').value = '';
    } catch (e) {
      alert('Erro ao salvar material.');
      console.error(e);
    }
  }

  function atualizarListaMateriais() {
    const container = document.getElementById('listaMateriais');
    try {
      const materiais = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');
      container.innerHTML = Object.entries(materiais).map(([nome, qtd]) => `
        <div class="flex justify-between items-center bg-gray-700 p-3 border border-gray-600 rounded-lg" data-material="${nome}">
          <span class="material-name" data-original="${nome}">${nome}</span>
          <span class="material-qtd" data-original="${qtd}">${qtd}</span>
          <div>
            <i class="fas fa-edit ml-2 cursor-pointer edit-btn" onclick="editMaterial('${nome}')"></i>
            <button class="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-primary-color ml-2" onclick="removerMaterial('${nome}')">Remover</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      container.innerHTML = '<p class="text-red-600">Erro ao carregar materiais.</p>';
      console.error(e);
    }
  }

  function removerMaterial(nome) {
    try {
      const materiais = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');
      delete materiais[nome];
      localStorage.setItem('materiaisDisponiveis', JSON.stringify(materiais));
      atualizarListaMateriais();
      atualizarMateriaisSelecionaveis();
    } catch (e) {
      alert('Erro ao remover material.');
      console.error(e);
    }
  }

  function editMaterial(nome) {
    const container = document.getElementById('listaMateriais');
    const materialItem = container.querySelector(`[data-material="${nome}"]`);
    if (!materialItem) {
      console.error(`Material ${nome} n√£o encontrado.`);
      return;
    }

    const nomeSpan = materialItem.querySelector('.material-name');
    const qtdSpan = materialItem.querySelector('.material-qtd');

    const originalNome = nomeSpan.dataset.original;
    const originalQtd = qtdSpan.dataset.original;

    nomeSpan.innerHTML = `<input type="text" class="edit-input w-24 p-1 bg-gray-600 border border-gray-500 rounded-lg text-gray-200" value="${originalNome}">`;
    qtdSpan.innerHTML = `<input type="number" min="0" class="edit-input w-16 p-1 bg-gray-600 border border-gray-500 rounded-lg text-gray-200" value="${originalQtd}">`;

    const nomeInput = nomeSpan.querySelector('input');
    const qtdInput = qtdSpan.querySelector('input');

    nomeInput.focus();

    nomeInput.addEventListener('blur', () => {
      const newNome = nomeInput.value.trim();
      if (!newNome) {
        alert('O nome do material n√£o pode estar vazio.');
        nomeInput.value = originalNome;
        return;
      }
      try {
        const materiais = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');
        const currentQtd = materiais[originalNome] || 0;
        delete materiais[originalNome];
        materiais[newNome] = currentQtd;
        localStorage.setItem('materiaisDisponiveis', JSON.stringify(materiais));
        nomeSpan.dataset.original = newNome;
        nomeSpan.textContent = newNome;
        materialItem.dataset.material = newNome;
        atualizarMateriaisSelecionaveis();
      } catch (e) {
        alert('Erro ao salvar edi√ß√£o do nome.');
        console.error(e);
        nomeSpan.textContent = originalNome;
      }
    });

    qtdInput.addEventListener('blur', () => {
      const newQtd = parseInt(qtdInput.value) || 0;
      if (newQtd < 0) {
        alert('A quantidade n√£o pode ser negativa.');
        qtdInput.value = originalQtd;
        return;
      }
      try {
        const materiais = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');
        materiais[originalNome] = newQtd;
        localStorage.setItem('materiaisDisponiveis', JSON.stringify(materiais));
        qtdSpan.dataset.original = newQtd;
        qtdSpan.textContent = newQtd;
        atualizarMateriaisSelecionaveis();
      } catch (e) {
        alert('Erro ao salvar edi√ß√£o da quantidade.');
        console.error(e);
        qtdSpan.textContent = originalQtd;
      }
    });
  }

function atualizarMateriaisSelecionaveis() {
  const container = document.getElementById('materiaisSelecionaveis');
  try {
    const disponiveis = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');
    const usados = JSON.parse(localStorage.getItem('materiaisSelecionados') || '{}');
    
    container.innerHTML = Object.entries(disponiveis).map(([nome, total]) => {
      const atual = usados[nome] || 0;
      return `
        <div class="flex justify-between items-center bg-gray-700 p-3 border border-gray-600 rounded-lg">
          <span><strong>${nome}</strong> (${total} dispon√≠veis)</span>
          <input 
            type="number" 
            min="0" 
            max="${total}" 
            value="${atual}" 
            class="material-input w-16 p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" 
            data-nome="${nome}" 
            data-valor-original="${atual}"
          >
        </div>
      `;
    }).join('');
    
    // Eventos para os inputs
    document.querySelectorAll('.material-input').forEach(input => {
      // Ao focar, zera o valor
      input.addEventListener('focus', () => {
        input.value = '';
      });
      
      // Ao sair do campo (blur), restaura se estiver vazio
      input.addEventListener('blur', () => {
        if (input.value === '') {
          input.value = input.dataset.valorOriginal;
        }
      });
      
      // Ao mudar valor, atualiza no localStorage
      input.addEventListener('change', () => {
        const nome = input.dataset.nome;
        atualizarUsoMaterial(nome, input.value);
      });
    });
    
  } catch (e) {
    container.innerHTML = '<p class="text-red-600">Erro ao carregar materiais selecion√°veis.</p>';
    console.error(e);
  }
}
  function atualizarUsoMaterial(nome, valor) {
    try {
      const usados = JSON.parse(localStorage.getItem('materiaisSelecionados') || '{}');
      const disponiveis = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');
      const qtd = Math.min(Math.max(0, parseInt(valor) || 0), disponiveis[nome] || 0);
      usados[nome] = qtd;
      localStorage.setItem('materiaisSelecionados', JSON.stringify(usados));
    } catch (e) {
      alert('Erro ao atualizar uso de material.');
      console.error(e);
    }
  }

  function atualizarContadorInstalacoes() {
    try {
      const historico = JSON.parse(localStorage.getItem('historicoInstalacoes') || '[]');
      const now = new Date();
      const mesAtual = now.getMonth();
      const anoAtual = now.getFullYear();
      const instalacoesMes = historico.filter(item => {
        const data = new Date(item.timestamp);
        return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
      }).length;
      document.getElementById('contadorInstalacoes').textContent = `${instalacoesMes} instala√ß√µes este m√™s`;
    } catch (e) {
      document.getElementById('contadorInstalacoes').textContent = 'Erro ao carregar contador';
      console.error(e);
    }
  }

  function salvarHistorico(instalacao) {
    try {
      const historico = JSON.parse(localStorage.getItem('historicoInstalacoes') || '[]');
      historico.push({ ...instalacao, timestamp: new Date().toISOString() });
      localStorage.setItem('historicoInstalacoes', JSON.stringify(historico));
      atualizarContadorInstalacoes();
      carregarHistorico();
    } catch (e) {
      alert('Erro ao salvar hist√≥rico.');
      console.error(e);
    }
  }

  function carregarHistorico() {
    const container = document.getElementById('historicoInstalacoes');
    try {
      const historico = JSON.parse(localStorage.getItem('historicoInstalacoes') || '[]');
      const searchTerm = document.getElementById('searchHistorico').value.toLowerCase();
      const filteredHistorico = searchTerm
        ? historico.filter(item => 
            Object.values(item).some(value => 
              value.toString().toLowerCase().includes(searchTerm)
            )
          )
        : historico;

      container.innerHTML = filteredHistorico.length
        ? filteredHistorico.map(item => `
          <div class="historico-item" data-details='${JSON.stringify(item)}'>
            <p class="text-lg font-semibold">${item.cliente}</p>
          </div>
        `).join('')
        : '<p class="text-gray-400">Nenhuma instala√ß√£o registrada.</p>';

      // Adicionar evento de clique para expandir
      document.querySelectorAll('.historico-item').forEach(item => {
        item.addEventListener('click', () => {
          const details = JSON.parse(item.dataset.details);
          if (item.classList.contains('expanded')) {
            item.innerHTML = `<p class="text-lg font-semibold">${details.cliente}</p>`;
            item.classList.remove('expanded');
          } else {
            item.innerHTML = `
              <p><strong>Cliente:</strong> ${details.cliente}</p>
              <p><strong>CTO:</strong> ${details.cto} <br> <strong>Porta:</strong> ${details.porta}</p>
              <p><strong>Sinal CTO:</strong> ${details.sinalCTO} dBm <br> <strong>Sinal Cliente:</strong> ${details.sinalCliente} dBm</p>
              <p><strong>Data:</strong> ${new Date(details.timestamp).toLocaleString()}</p>
              <p><strong>Endere√ßo:</strong> ${details.endereco}</p>
              <p><strong>Mapa:</strong> <a href="${details.linkMapa}" target="_blank" rel="noopener noreferrer" class="text-secondary-color hover:underline">Abrir no Google Maps</a></p>
            `;
            item.classList.add('expanded');
          }
        });
      });
    } catch (e) {
      container.innerHTML = '<p class="text-red-600">Erro ao carregar hist√≥rico.</p>';
      console.error(e);
    }
  }

  function validateForm(formData) {
    const errors = [];
    if (!formData.get('tipoTrabalho')) errors.push({ field: 'tipoTrabalho', message: 'Por favor selecione o tipo de trabalho.' });
    if (!formData.get('tecnico')) errors.push({ field: 'tecnico', message: 'Por favor selecione o t√©cnico.' });
    if (!formData.get('cliente').trim()) errors.push({ field: 'cliente', message: 'Por favor informe o cliente.' });
    if (!formData.get('cto').trim()) errors.push({ field: 'cto', message: 'Por favor informe o CTO.' });
    if (!formData.get('porta')) errors.push({ field: 'porta', message: 'Por favor selecione a porta.' });
    const sinalCTO = parseInt(formData.get('sinalCTO'));
    if (sinalCTO < -30 || sinalCTO > -10) errors.push({ field: 'sinalCTO', message: 'Por favor ajuste o sinal da CTO entre -30 e -10 dBm.' });
    const sinalCliente = parseInt(formData.get('sinalCliente'));
    if (sinalCliente < -30 || sinalCliente > -10) errors.push({ field: 'sinalCliente', message: 'Por favor ajuste o sinal do cliente entre -30 e -10 dBm.' });

    document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
    errors.forEach(({ field, message }) => {
      const errorEl = document.querySelector(`#${field} + p.error-message`) || document.querySelector(`[name="${field}"] + p.error-message`);
      if (errorEl) errorEl.style.display = 'block';
    });

    return errors.length === 0;
  }

  document.getElementById('formInstalacao').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    if (!validateForm(formData)) return;

    const instalacao = {
      tipo: formData.get('tipoTrabalho'),
      tecnico: formData.get('tecnico'),
      cliente: formData.get('cliente').trim(),
      cto: formData.get('cto').trim(),
      porta: formData.get('porta'),
      sinalCTO: formData.get('sinalCTO'),
      sinalCliente: formData.get('sinalCliente'),
      endereco: formData.get('endereco').trim() || 'Endere√ßo n√£o definido',
      lat: sessionStorage.getItem('lat') || '-23.21345',
      lng: sessionStorage.getItem('lng') || '-47.29821'
    };

    const linkMapa = `https://maps.google.com/?q=${instalacao.lat},${instalacao.lng}`;
    try {
      const materiaisSelecionados = JSON.parse(localStorage.getItem('materiaisSelecionados') || '{}');
      const materiaisDisponiveis = JSON.parse(localStorage.getItem('materiaisDisponiveis') || '{}');

      // Validar e atualizar estoque de materiais
      let estoqueAtualizado = { ...materiaisDisponiveis };
      let erroEstoque = false;
      for (const [nome, qtdUsada] of Object.entries(materiaisSelecionados)) {
        const qtdDisponivel = materiaisDisponiveis[nome] || 0;
        if (qtdUsada > qtdDisponivel) {
          alert(`Quantidade insuficiente de ${nome}. Dispon√≠vel: ${qtdDisponivel}, Usada: ${qtdUsada}.`);
          erroEstoque = true;
          break;
        }
        estoqueAtualizado[nome] = qtdDisponivel - qtdUsada;
      }

      if (erroEstoque) return;

      // Atualizar o estoque no localStorage
      localStorage.setItem('materiaisDisponiveis', JSON.stringify(estoqueAtualizado));
      localStorage.removeItem('materiaisSelecionados');
      atualizarListaMateriais();
      atualizarMateriaisSelecionaveis();

      const materiaisTexto = Object.entries(materiaisSelecionados)
        .filter(([_, qtd]) => qtd > 0)
        .map(([nome, qtd]) => `‚Ä¢ ${nome}: ${qtd}`)
        .join('\n') || 'Nenhum material registrado.';

      const msg = `üì° **Registro de Instala√ß√£o - IndaiaFibra**\n\n` +
                  `üîß **Tipo de Trabalho:** ${instalacao.tipo}\n` +
                  `üë®‚Äçüîß **T√©cnico:** ${instalacao.tecnico}\n` +
                  `üôç **Cliente:** ${instalacao.cliente}\n` +
                  `üß∞ **CTO:** ${instalacao.cto}\n` +
                  `üîå **Porta:** ${instalacao.porta}\n` +
                  `üì∂ **Sinal CTO:** ${instalacao.sinalCTO} dBm\n` +
                  `üì∂ **Sinal Cliente:** ${instalacao.sinalCliente} dBm\n` +
                  `üìç **Endere√ßo:** ${instalacao.endereco} ${linkMapa}\n\n` +
                  `üì¶**Materiais Utilizados:**\n${materiaisTexto}`;

      await navigator.clipboard.writeText(msg);
      alert('Mensagem copiada! Agora cole no grupo do Telegram.');
      window.open('https://t.me/c/1989058391/38071', '_blank');

      salvarHistorico({ ...instalacao, linkMapa });
      carregarHistorico();
      form.reset();
      document.getElementById('valorSinalCTO').textContent = '-20 dBm';
      document.getElementById('valorSinalCliente').textContent = '-20 dBm';
      document.getElementById('sinalCTO').value = '-20';
      document.getElementById('sinalCliente').value = '-20';
    } catch (err) {
      alert('Erro ao processar a instala√ß√£o.');
      console.error(err);
      // Rollback em caso de erro
      localStorage.setItem('materiaisDisponiveis', JSON.stringify(materiaisDisponiveis));
      localStorage.setItem('materiaisSelecionados', JSON.stringify(materiaisSelecionados));
      atualizarListaMateriais();
      atualizarMateriaisSelecionaveis();
    }
  });

  document.getElementById('sinalCTO').addEventListener('input', () => {
    document.getElementById('valorSinalCTO').textContent = `${document.getElementById('sinalCTO').value} dBm`;
  });

  document.getElementById('sinalCliente').addEventListener('input', () => {
    document.getElementById('valorSinalCliente').textContent = `${document.getElementById('sinalCliente').value} dBm`;
  });

  document.getElementById('usarLocalizacao').addEventListener('click', usarLocalizacao);

  document.getElementById('endereco').addEventListener('input', (e) => {
    clearTimeout(enderecoTimeout);
    enderecoTimeout = setTimeout(() => {
      const endereco = e.target.value.trim();
      if (endereco) buscarEndereco(endereco);
    }, 1000);
  });

  document.getElementById('adicionarMaterial').addEventListener('click', adicionarMaterial);

  document.getElementById('limparHistorico').addEventListener('click', () => {
    if (confirm('Tem certeza que deseja limpar o hist√≥rico?')) {
      localStorage.removeItem('historicoInstalacoes');
      carregarHistorico();
      atualizarContadorInstalacoes();
    }
  });

  document.getElementById('openGoogleMaps').addEventListener('click', () => {
    window.open('https://goo.gl/maps/88VJ2ZpSiy4F2Qas7', '_blank');
  });

  document.getElementById('openGoogleEarth').addEventListener('click', () => {
    window.open('geo:-23.21345,-47.29821', '_blank');
  });

      document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault(); // Evita m√∫ltiplos cliques
        const nav = document.querySelector('nav');
        nav.classList.remove('nav-minimized'); // Expande imediatamente ao clicar
        sessionStorage.setItem('navMinimized', 'false');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        const targetContent = document.getElementById(btn.dataset.tab);
        targetContent.classList.remove('hidden');
        setTimeout(() => targetContent.classList.add('active'), 150); // Pequeno delay para iniciar anima√ß√£o
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (btn.dataset.tab === 'instalacao') setTimeout(() => mapInstalacao.invalidateSize(), 100);
      });
    });

  // Busca em tempo real no hist√≥rico
  document.getElementById('searchHistorico').addEventListener('input', (e) => {
    carregarHistorico();
  });

  window.addEventListener('DOMContentLoaded', () => {
    try {
      initMaps();
      atualizarListaMateriais();
      atualizarMateriaisSelecionaveis();
      carregarHistorico();
      atualizarContadorInstalacoes();
      const navMinimized = sessionStorage.getItem('navMinimized') === 'true';
      if (navMinimized) document.querySelector('nav').classList.add('nav-minimized');
      document.querySelector('.tab-btn[data-tab="instalacao"]').click();
    } catch (e) {
      alert('Erro ao inicializar a aplica√ß√£o.');
      console.error(e);
    }
  });
</script>
</body>
</html>