<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IndaiaFibra</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1E3A8A;
      --secondary-color: #06B6D4;
      --background-color: linear-gradient(to bottom, #1F2937, #111827);
      --text-color: #F9FAFB;
      --error-color: #DC2626;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
      transition: background 0.3s ease, color 0.3s ease;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(17, 24, 39, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .loader-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loader-icon {
      width: 48px;
      height: 48px;
      animation: float 1.5s ease-in-out infinite;
      z-index: 1;
    }

    .loader-spinner {
      position: absolute;
      border: 4px solid var(--secondary-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 64px;
      height: 64px;
      animation: spin 1s linear infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: #4B5563;
      border-radius: 4px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--secondary-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--secondary-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #mapInstalacao {
      height: 16rem;
      border: 1px solid var(--secondary-color);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1;
    }

    .error-message {
      color: var(--error-color);
      font-size: 0.875rem;
      display: none;
    }

    .tab-btn.active {
      background: var(--primary-color);
      color: var(--text-color);
    }

    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1F2937;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      overflow-x: auto;
      white-space: nowrap;
      transition: height 0.3s ease;
    }

    nav.nav-minimized .tab-btn span {
      display: none;
    }

    .tab-btn {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
    }

    .tab-btn span {
      background: var(--primary-color);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      display: none;
      width: 100%;
      text-align: right;
    }

    .tab-btn.active span {
      display: flex;
      width: 100%;
    }

    .tab-btn i {
      margin-right: 0.5rem;
    }

    .logo-text {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    button, input[type="submit"] {
      background-color: var(--secondary-color);
      color: var(--text-color);
      transition: background-color 0.2s ease-in-out;
    }

    button:hover, input[type="submit"]:hover {
      background-color: var(--primary-color);
      color: var(--text-color);
    }

    .edit-btn {
      cursor: pointer;
      color: var(--secondary-color);
      margin-left: 0.5rem;
    }

    .edit-btn:hover {
      color: var(--primary-color);
    }

    @media (min-width: 768px) {
      #mapInstalacao { height: 24rem; }
      .tab-btn { font-size: 1rem; padding: 0.75rem 1.5rem; }
      .tab-btn.active span { max-width: 250px; }
    }

    @media (max-width: 767px) {
      .tab-btn { font-size: 0.875rem; padding: 0.5rem 1rem; }
      .tab-btn.active span { max-width: 150px; }
    }

    .historico-item {
      cursor: pointer;
      padding: 0.5rem;
      background-color: #374151;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .historico-item.expanded {
      background-color: #4B5563;
      padding: 1rem;
    }

    #searchHistorico {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      background-color: #374151;
      border: 1px solid #4B5563;
      border-radius: 0.25rem;
      color: #F9FAFB;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loader-container">
      <img src="https://img.icons8.com/?size=2x&id=Sd1fJXRt5uTd&format=png" alt="Loading Icon" class="loader-icon">
      <div class="loader-spinner"></div>
    </div>
  </div>

  <header class="bg-primary-color text-white p-4 flex justify-between items-center shadow-lg">
    <div class="flex items-center">
      <img src="https://img.icons8.com/?size=2x&id=Sd1fJXRt5uTd&format=png" alt="Logo IndaiaFibra" class="h-12 mr-2 cursor-pointer" id="logoIndaiaFibra">
      <h1 class="text-xl font-semibold logo-text">IndaiaFibra</h1>
    </div>
    <div class="text-sm">
      <span id="contadorInstalacoes">0 instalações este mês</span>
    </div>
  </header>

  <main class="flex-grow p-6 max-w-4xl mx-auto mb-16">
    <section id="instalacao" class="tab-content" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <form id="formInstalacao" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="tipoTrabalho" class="block font-semibold text-gray-200">Tipo de trabalho *</label>
              <select id="tipoTrabalho" name="tipoTrabalho" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color">
                <option value="">Selecione</option>
                <option value="Instalação">Instalação</option>
                <option value="Manutenção">Manutenção</option>
              </select>
              <p class="error-message mt-1">Por favor selecione o tipo de trabalho.</p>
            </div>
            <div>
              <label for="tecnico" class="block font-semibold text-gray-200">Técnico *</label>
              <select id="tecnico" name="tecnico" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color">
                <option value="">Selecione</option>
                <option value="André">André</option>
                <option value="Elvis">Elvis</option>
                <option value="Guilherme">Guilherme</option>
                <option value="Janderson">Janderson</option>
                <option value="Robson">Robson</option>
                <option value="Sérgio">Sérgio</option>
              </select>
              <p class="error-message mt-1">Por favor selecione o técnico.</p>
            </div>
          </div>
          <div>
            <label for="cliente" class="block font-semibold text-gray-200">Cliente *</label>
            <input id="cliente" name="cliente" type="text" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Nome do cliente">
            <p class="error-message mt-1">Por favor informe o cliente.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="cto" class="block font-semibold text-gray-200">CTO *</label>
              <input id="cto" name="cto" type="text" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Identificador CTO">
              <p class="error-message mt-1">Por favor informe o CTO.</p>
            </div>
            <div>
              <label for="porta" class="block font-semibold text-gray-200">Porta *</label>
              <select id="porta" name="porta" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color">
                <option value="">Selecione</option>
                <option value="2">Porta 2</option>
                <option value="3">Porta 3</option>
                <option value="4">Porta 4</option>
                <option value="5">Porta 5</option>
                <option value="6">Porta 6</option>
                <option value="7">Porta 7</option>
                <option value="8">Porta 8</option>
                <option value="9">Porta 9</option>
                <option value="10">Porta 10</option>
                <option value="11">Porta 11</option>
                <option value="12">Porta 12</option>
                <option value="13">Porta 13</option>
                <option value="14">Porta 14</option>
                <option value="15">Porta 15</option>
                <option value="16">Porta 16</option>
              </select>
              <p class="error-message mt-1">Por favor selecione a porta.</p>
            </div>
          </div>
          <div>
            <label for="sinalCTO" class="block font-semibold text-gray-200">Sinal da CTO (-30 a -10 dBm) *</label>
            <input id="sinalCTO" name="sinalCTO" type="range" min="-30" max="-10" step="1" value="-20" class="w-full">
            <p id="valorSinalCTO" class="text-sm text-gray-400 mt-1">-20 dBm</p>
            <p class="error-message mt-1">Por favor ajuste o sinal da CTO entre -30 e -10 dBm.</p>
          </div>
          <div>
            <label for="sinalCliente" class="block font-semibold text-gray-200">Sinal do Cliente (-30 a -10 dBm) *</label>
            <input id="sinalCliente" name="sinalCliente" type="range" min="-30" max="-10" step="1" value="-20" class="w-full">
            <p id="valorSinalCliente" class="text-sm text-gray-400 mt-1">-20 dBm</p>
            <p class="error-message mt-1">Por favor ajuste o sinal do cliente entre -30 e -10 dBm.</p>
          </div>
          <div>
            <label class="block font-semibold text-gray-200">Localização *</label>
            <div id="mapInstalacao" class="mt-2"></div>
            <button type="button" id="usarLocalizacao" class="bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color flex items-center">
              <i class="fas fa-map-marker-alt mr-2"></i> Usar minha localização atual
            </button>
            <input id="endereco" name="endereco" type="text" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg mt-3 text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Digite ou selecione no mapa">
          </div>
          <div>
            <label class="block font-semibold text-gray-200">Materiais para esta instalação</label>
            <div id="materiaisSelecionaveis" class="space-y-3 mt-2"></div>
          </div>
          <button type="submit" class="bg-secondary-color text-white px-6 py-3 rounded-lg hover:bg-primary-color w-full md:w-auto">Enviar Instalação</button>
        </form>
      </div>
    </section>

    <section id="materiais" class="tab-content hidden" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-200 mb-4">Gerenciar Materiais</h2>
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="nomeMaterial" class="block font-semibold text-gray-200">Nome do Material</label>
              <input id="nomeMaterial" type="text" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Ex: Cabo Óptico">
            </div>
            <div>
              <label for="qtdMaterial" class="block font-semibold text-gray-200">Quantidade padrão</label>
              <input id="qtdMaterial" type="number" min="1" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-secondary-color" placeholder="Ex: 10">
            </div>
          </div>
          <button id="adicionarMaterial" class="bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">Adicionar</button>
          <div id="listaMateriais" class="space-y-3"></div>
        </div>
      </div>
    </section>

    <section id="historico" class="tab-content hidden" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-200 mb-4">Histórico de Instalações</h2>
        <input type="text" id="searchHistorico" placeholder="Pesquisar..." class="mb-4">
        <div id="historicoInstalacoes" class="space-y-2"></div>
        <button id="limparHistorico" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-primary-color mt-4">Limpar Histórico</button>
      </div>
    </section>

    <section id="mapa" class="tab-content hidden" data-aos="fade-up">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-200 mb-4">Mapa CTOs</h2>
        <div class="space-y-4">
          <button id="openGoogleMaps" class="bg-secondary-color text-white px-6 py-3 rounded-lg hover:bg-primary-color flex items-center justify-center w-full md:w-auto">
            <i class="fas fa-map-pin mr-2"></i> Abrir no Google Maps
          </button>
          <button id="openGoogleEarth" class="bg-secondary-color text-white px-6 py-3 rounded-lg hover:bg-primary-color flex items-center justify-center w-full md:w-auto">
            <i class="fas fa-globe mr-2"></i> Abrir no Google Earth
          </button>
        </div>
      </div>
    </section>
  </main>

  <nav class="flex space-x-2 p-4 nav-minimized">
    <button data-tab="instalacao" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color active">
      <i class="fas fa-tools"></i><span>Instalação</span>
    </button>
    <button data-tab="materiais" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">
      <i class="fas fa-box"></i><span>Materiais</span>
    </button>
    <button data-tab="historico" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">
      <i class="fas fa-history"></i><span>Histórico</span>
    </button>
    <button data-tab="mapa" class="tab-btn bg-secondary-color text-white px-4 py-2 rounded-lg hover:bg-primary-color">
      <i class="fas fa-map-pin"></i><span>Mapa CTOs</span>
    </button>
  </nav>

  <footer class="bg-primary-color text-white p-4 text-center">
    <p>IndaiaFibra v1.13.0 © 2025</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script></script>
                  
                  
                  <script>
  AOS.init({ duration: 600 });

  // Fallback para remover loading screen
  setTimeout(() => {
    const loading = document.getElementById('loading');
    if (loading) loading.style.display = 'none';
  }, 5000);

  window.addEventListener('load', () => {
    document.getElementById('loading').style.display = 'none';
  });

  let mapInstalacao, markerInstalacao;
  let enderecoTimeout;

  // Função para trocar o tema
  function toggleTheme() {
    const root = document.documentElement;
    const currentTheme = sessionStorage.getItem('theme') || 'default';
    if (currentTheme === 'default') {
      root.style.setProperty('--primary-color', '#FF6B6B');
      root.style.setProperty('--secondary-color', '#4ECDC4');
      sessionStorage.setItem('theme', 'alternate');
    } else {
      root.style.setProperty('--primary-color', '#1E3A8A');
      root.style.setProperty('--secondary-color', '#06B6D4');
      sessionStorage.setItem('theme', 'default');
    }
    // Atualiza o gradiente do logo-text
    document.querySelector('.logo-text').style.backgroundImage = `linear-gradient(to right, ${root.style.getPropertyValue('--primary-color')}, ${root.style.getPropertyValue('--secondary-color')})`;
  }

  // Aplica o tema salvo ao carregar
  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = sessionStorage.getItem('theme') || 'default';
    if (savedTheme === 'alternate') {
      toggleTheme();
    }
    document.getElementById('logoIndaiaFibra').addEventListener('click', toggleTheme);
  });

  function initMaps() {
    mapInstalacao = L.map('mapInstalacao', { zoomControl: true }).setView([-23.21345, -47.29821], 15);
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | © <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(mapInstalacao);

    const customIcon = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      shadowSize: [41, 41]
    });

    mapInstalacao.on('click', async (e) => {
      const { lat, lng } = e.latlng;
      updateMarker(lat, lng, mapInstalacao, 'markerInstalacao', customIcon);
      const endereco = await obterEndereco(lat, lng);
      document.getElementById('endereco').value = endereco;
    });

    // Forçar re-renderização do mapa
    setTimeout(() => mapInstalacao.invalidateSize(), 100);
  }

  function updateMarker(lat, lng, targetMap, markerType, icon) {
    sessionStorage.setItem('lat', lat);
    sessionStorage.setItem('lng', lng);
    if (markerType === 'markerInstalacao' && markerInstalacao) mapInstalacao.removeLayer(markerInstalacao);
    const newMarker = L.marker([lat, lng], { icon }).addTo(targetMap);
    if (markerType === 'markerInstalacao') markerInstalacao = newMarker;
    targetMap.setView([lat, lng], 17);
    targetMap.invalidateSize();
  }

  async function usarLocalizacao() {
    if (!navigator.geolocation) {
      alert('Geolocalização não suportada.');
      return;
    }
    const loading = document.getElementById('loading');
    loading.style.display = 'flex';
    document.getElementById('usarLocalizacao').disabled = true;

    const timeoutId = setTimeout(() => {
      loading.style.display = 'none';
      alert('Não foi possível obter sua localização dentro de 40 segundos. Tente novamente.');
      document.getElementById('usarLocalizacao').disabled = false;
    }, 40000);

    try {
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject);
      });
      clearTimeout(timeoutId);
      const { latitude: lat, longitude: lng } = pos.c